# Plan 04-02: Directory Watch, Auto-Refresh, VSIX Packaging

## Objective

Add directory watch mode that detects new/changed MD and HTML files with notifications, wire up auto-refresh for open files, and package the extension as a clean VSIX ready for local install. This is the final plan -- after this, Ark Lens is shippable.

## Context

@.planning/PROJECT.md
@.planning/phases/04-file-integration/04-CONTEXT.md
@.planning/phases/04-file-integration/04-01-PLAN.md (completed commands + settings)

## Pre-Flight

- [ ] Plan 04-01 complete -- commands, menus, settings working
- [ ] `arkLens.watchDirectory` setting exists but not yet implemented

## Tasks

### Task 1: File Watcher Service

Create `src/providers/fileWatcher.ts`:

```typescript
import * as vscode from 'vscode';

export class FileWatcherService {
  private watcher: vscode.FileSystemWatcher | null = null;
  private watchedDir: string = '';
  private statusBarItem: vscode.StatusBarItem;

  constructor() {
    this.statusBarItem = vscode.window.createStatusBarItem(
      vscode.StatusBarAlignment.Right, 100
    );
  }

  start(directory: string): void {
    this.stop(); // Clean up any existing watcher

    if (!directory) return;

    const uri = vscode.Uri.file(directory);
    const pattern = new vscode.RelativePattern(uri, '**/*.{md,html,htm}');

    this.watcher = vscode.workspace.createFileSystemWatcher(pattern);
    this.watchedDir = directory;

    // New file created
    this.watcher.onDidCreate(fileUri => {
      const fileName = path.basename(fileUri.fsPath);
      vscode.window.showInformationMessage(
        `Ark Lens: New file detected - ${fileName}`,
        'Open'
      ).then(action => {
        if (action === 'Open') {
          vscode.commands.executeCommand('arkLens.openPreview', fileUri);
        }
      });
    });

    // File changed
    this.watcher.onDidChange(fileUri => {
      // Notify viewer to refresh if this file is open in a tab
      ViewerProvider.instance?.refreshFile(fileUri.fsPath);
    });

    // File deleted
    this.watcher.onDidDelete(fileUri => {
      // Notify viewer to close tab if open
      ViewerProvider.instance?.closeFile(fileUri.fsPath);
    });

    // Status bar indicator
    this.statusBarItem.text = '$(eye) Ark Lens';
    this.statusBarItem.tooltip = `Watching: ${directory}`;
    this.statusBarItem.command = 'arkLens.stopWatching';
    this.statusBarItem.show();
  }

  stop(): void {
    if (this.watcher) {
      this.watcher.dispose();
      this.watcher = null;
    }
    this.statusBarItem.hide();
    this.watchedDir = '';
  }

  isWatching(): boolean {
    return this.watcher !== null;
  }

  dispose(): void {
    this.stop();
    this.statusBarItem.dispose();
  }
}
```

### Task 2: Watch Commands Implementation

Update `src/extension.ts`:

```typescript
const fileWatcher = new FileWatcherService();
context.subscriptions.push(fileWatcher);

// Watch directory command
context.subscriptions.push(
  vscode.commands.registerCommand('arkLens.watchDirectory', async () => {
    const config = vscode.workspace.getConfiguration('arkLens');
    let watchDir = config.get<string>('watchDirectory', '');

    if (!watchDir) {
      // Prompt user to select directory
      const result = await vscode.window.showOpenDialog({
        canSelectFiles: false,
        canSelectFolders: true,
        canSelectMany: false,
        title: 'Select directory to watch for Markdown/HTML files',
      });

      if (!result || result.length === 0) return;
      watchDir = result[0].fsPath;

      // Save to settings
      await config.update('watchDirectory', watchDir, vscode.ConfigurationTarget.Workspace);
    }

    fileWatcher.start(watchDir);
    vscode.window.showInformationMessage(`Ark Lens: Watching ${watchDir}`);
  })
);

// Stop watching command
context.subscriptions.push(
  vscode.commands.registerCommand('arkLens.stopWatching', () => {
    fileWatcher.stop();
    vscode.window.showInformationMessage('Ark Lens: Stopped watching');
  })
);

// Auto-start watcher if directory configured
const watchDir = vscode.workspace.getConfiguration('arkLens').get<string>('watchDirectory', '');
if (watchDir) {
  fileWatcher.start(watchDir);
}
```

**Verification:**
- [ ] Watch command opens folder picker if no directory configured
- [ ] Status bar shows watching indicator
- [ ] New .md file in watched directory triggers notification
- [ ] Clicking "Open" in notification opens file in viewer
- [ ] Changed file auto-refreshes if open in viewer
- [ ] Deleted file closes tab if open
- [ ] Stop command removes watcher and status bar
- [ ] Auto-starts on extension load if directory configured

### Task 3: Auto-Refresh for Open Files

Update `src/providers/viewerProvider.ts`:

```typescript
// Track open documents for change detection
private openDocumentListener: vscode.Disposable | null = null;

setupAutoRefresh(): void {
  // Listen for text document changes
  this.openDocumentListener = vscode.workspace.onDidChangeTextDocument(
    debounce((event: vscode.TextDocumentChangeEvent) => {
      const filePath = event.document.uri.fsPath;
      // Only refresh if this file is open in the viewer
      this.panel.webview.postMessage({
        type: 'updateFile',
        filePath,
        content: event.document.getText(),
      });
    }, 300) // 300ms debounce
  );
}

refreshFile(filePath: string): void {
  // For FileSystemWatcher changes (file changed externally)
  vscode.workspace.openTextDocument(vscode.Uri.file(filePath)).then(doc => {
    this.panel.webview.postMessage({
      type: 'updateFile',
      filePath,
      content: doc.getText(),
    });
  });
}

closeFile(filePath: string): void {
  this.panel.webview.postMessage({
    type: 'closeFile',
    filePath,
  });
}
```

Update webview app to handle `updateFile`:
- Find tab by filePath
- Update content, mark as dirty
- If active tab, re-render immediately
- If inactive tab, mark dirty (renders on switch)
- Brief visual indicator: subtle flash on content area

**Verification:**
- [ ] Editing .md file in editor → viewer updates within 500ms
- [ ] External file change (e.g., git checkout) → viewer updates
- [ ] Only active tab re-renders on change (inactive tabs lazy)
- [ ] Debounce prevents excessive re-renders during typing
- [ ] Visual feedback that content refreshed

### Task 4: VSIX Packaging

Install vsce:
```bash
npm install -D @vscode/vsce
```

Create `.vscodeignore`:
```
.vscode/**
src/**
node_modules/**
*.ts
tsconfig.json
esbuild.config.mjs
.gitignore
.planning/**
test/**
**/*.map
```

Add package script to `package.json`:
```json
{
  "scripts": {
    "build": "node esbuild.config.mjs",
    "watch": "node esbuild.config.mjs --watch",
    "lint": "tsc --noEmit",
    "package": "npm run build && vsce package",
    "install-local": "code --install-extension ark-lens-*.vsix"
  }
}
```

Create minimal `README.md`:
```markdown
# Ark Lens

Secure, offline-first Markdown and HTML viewer for VS Code.

## Features
- Markdown rendering with GFM support
- Mermaid diagrams, Chart.js charts
- Syntax-highlighted code blocks
- Standalone HTML file viewing
- Multi-tab interface
- Dark/light theme with controls
- Directory watch mode
- Zero network requests, strict CSP

## Usage
1. Open a .md or .html file
2. Press Ctrl+Shift+L to open Ark Lens preview
3. Use the control bar to adjust theme, font, and width

## Security
- Strict Content Security Policy
- All rendering libraries bundled offline
- DOMPurify sanitises all HTML output
- No code execution from file content
- No network requests under any circumstance
```

Create `LICENSE` (MIT).

Create `CHANGELOG.md`:
```markdown
# Changelog

## 0.1.0 (Initial Release)
- Markdown rendering with GFM (tables, task lists, strikethrough)
- Mermaid diagram rendering (bundled offline)
- Chart.js chart rendering from JSON code blocks
- Syntax highlighting via Prism.js (20 languages)
- Standalone HTML file viewing (sanitised)
- Local image, video, audio embed support
- Multi-tab interface with closable tabs
- Dark/light theme toggle
- Font size, family, and content width controls
- Table of contents sidebar
- Directory watch mode
- Auto-refresh on file change
- Full VS Code settings integration
- Zero network requests, strict CSP
```

### Task 5: Build Validation

Run full build and package:

```bash
cd ark-lens
npm run build
npm run lint
npm run package
```

Validate VSIX:
- [ ] `vsce package` succeeds without errors
- [ ] VSIX file size is reasonable (<10MB)
- [ ] List contents: `vsce ls` -- no source files, no node_modules

Install and test:
```bash
code --install-extension ark-lens-0.1.0.vsix
```

**Full validation checklist:**
- [ ] Extension activates on opening .md file
- [ ] `Ctrl+Shift+L` opens viewer panel to the right
- [ ] Markdown renders with headings, code, tables, lists
- [ ] Mermaid diagrams render
- [ ] Chart.js charts render
- [ ] Code blocks syntax highlighted
- [ ] .html files render (sanitised)
- [ ] Local images display
- [ ] Multiple files open as tabs
- [ ] Tabs close, switch, preserve scroll
- [ ] Theme toggle works (dark/light)
- [ ] Font size +/- works
- [ ] Content width changes
- [ ] TOC sidebar generates and navigates
- [ ] Directory watch detects new files
- [ ] Auto-refresh on file edit
- [ ] Settings persist across restart
- [ ] Zero CSP violations in DevTools console
- [ ] Zero network requests in DevTools network tab
- [ ] No errors in Extension Host output channel

### Task 6: Security Final Audit

Before declaring v0.1.0 ready:

- [ ] Run `npm audit` -- zero critical or high vulnerabilities
- [ ] Grep codebase for `eval(`, `new Function(`, `innerHTML` without DOMPurify -- none found
- [ ] Verify CSP blocks all inline scripts (test with deliberate injection)
- [ ] Verify no `style` attributes pass through DOMPurify
- [ ] Verify `localResourceRoots` doesn't include root directory
- [ ] Verify no network requests by disconnecting network and testing all features
- [ ] Verify `<script>` tags in .md and .html files are stripped
- [ ] Verify `onerror`, `onclick`, etc. attributes stripped from all content

## Success Criteria

- [ ] Directory watch mode works end-to-end
- [ ] Auto-refresh works for both editor changes and external changes
- [ ] VSIX packages cleanly under 10MB
- [ ] Clean install from VSIX works without errors
- [ ] All 16 features from CHANGELOG verified working
- [ ] Security audit passes all checks
- [ ] Zero CSP violations, zero network requests
- [ ] Extension is ready for daily use
