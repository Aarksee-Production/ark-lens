# Plan 04-01: Commands, Context Menus, VS Code Settings

## Objective

Wire Ark Lens into VS Code's native UX: command palette commands with keybindings, right-click context menus on files and editors, and a proper settings contribution so preferences appear in VS Code's Settings UI.

## Context

@.planning/PROJECT.md
@.planning/phases/04-file-integration/04-CONTEXT.md
@.planning/phases/03-viewer-experience/03-02-PLAN.md (completed viewer UX)

## Pre-Flight

- [ ] Phase 3 complete -- tabs, themes, controls, TOC working
- [ ] Settings persistence bridge working (postMessage to extension)

## Tasks

### Task 1: Command Contributions

Update `package.json` contributes.commands:

```json
{
  "contributes": {
    "commands": [
      {
        "command": "arkLens.openPreview",
        "title": "Open Preview",
        "category": "Ark Lens",
        "icon": "$(open-preview)"
      },
      {
        "command": "arkLens.openPreviewToSide",
        "title": "Open Preview to the Side",
        "category": "Ark Lens",
        "icon": "$(open-preview)"
      },
      {
        "command": "arkLens.toggleTheme",
        "title": "Toggle Theme",
        "category": "Ark Lens"
      },
      {
        "command": "arkLens.watchDirectory",
        "title": "Watch Directory for Changes",
        "category": "Ark Lens"
      },
      {
        "command": "arkLens.stopWatching",
        "title": "Stop Watching Directory",
        "category": "Ark Lens"
      }
    ]
  }
}
```

### Task 2: Keybindings

```json
{
  "contributes": {
    "keybindings": [
      {
        "command": "arkLens.openPreview",
        "key": "ctrl+shift+l",
        "when": "editorLangId == markdown || editorLangId == html"
      },
      {
        "command": "arkLens.openPreviewToSide",
        "key": "ctrl+k l",
        "when": "editorLangId == markdown || editorLangId == html"
      }
    ]
  }
}
```

### Task 3: Context Menus

```json
{
  "contributes": {
    "menus": {
      "editor/title": [
        {
          "command": "arkLens.openPreview",
          "when": "editorLangId == markdown || editorLangId == html",
          "group": "navigation"
        }
      ],
      "editor/context": [
        {
          "command": "arkLens.openPreview",
          "when": "editorLangId == markdown || editorLangId == html",
          "group": "navigation"
        }
      ],
      "explorer/context": [
        {
          "command": "arkLens.openPreview",
          "when": "resourceLangId == markdown || resourceLangId == html",
          "group": "navigation"
        }
      ]
    }
  }
}
```

### Task 4: Command Implementations

Update `src/extension.ts`:

```typescript
// openPreview -- opens in current column or reveals existing panel
context.subscriptions.push(
  vscode.commands.registerCommand('arkLens.openPreview', () => {
    const editor = vscode.window.activeTextEditor;
    if (!editor) {
      vscode.window.showInformationMessage('No active editor. Open a Markdown or HTML file first.');
      return;
    }
    const doc = editor.document;
    if (!isSupported(doc)) {
      vscode.window.showInformationMessage('Ark Lens supports Markdown and HTML files.');
      return;
    }
    ViewerProvider.createOrShow(context.extensionUri, doc, vscode.ViewColumn.Beside);
  })
);

// openPreviewToSide -- always opens to the side
context.subscriptions.push(
  vscode.commands.registerCommand('arkLens.openPreviewToSide', () => {
    // Same as above but forces ViewColumn.Beside
  })
);

// toggleTheme -- sends message to webview
context.subscriptions.push(
  vscode.commands.registerCommand('arkLens.toggleTheme', () => {
    ViewerProvider.instance?.postMessage({ type: 'toggleTheme' });
  })
);

// Context menu on explorer -- opens file by URI
context.subscriptions.push(
  vscode.commands.registerCommand('arkLens.openPreview', async (uri?: vscode.Uri) => {
    if (uri) {
      const doc = await vscode.workspace.openTextDocument(uri);
      ViewerProvider.createOrShow(context.extensionUri, doc, vscode.ViewColumn.Beside);
    }
    // Falls through to active editor if no URI
  })
);

function isSupported(doc: vscode.TextDocument): boolean {
  return ['markdown', 'html'].includes(doc.languageId);
}
```

**Verification:**
- [ ] `Ctrl+Shift+L` opens preview when MD/HTML file is active
- [ ] `Ctrl+K L` opens preview to the side
- [ ] Right-click on .md file in Explorer shows "Open Preview"
- [ ] Right-click in editor shows "Open Preview"
- [ ] Editor title bar shows preview icon
- [ ] Commands appear in command palette with "Ark Lens:" prefix
- [ ] Error message when no active editor or unsupported file

### Task 5: Settings Contribution

```json
{
  "contributes": {
    "configuration": {
      "title": "Ark Lens",
      "properties": {
        "arkLens.theme": {
          "type": "string",
          "default": "auto",
          "enum": ["auto", "light", "dark"],
          "enumDescriptions": [
            "Follow VS Code theme",
            "Always use light theme",
            "Always use dark theme"
          ],
          "description": "Viewer colour theme"
        },
        "arkLens.fontSize": {
          "type": "number",
          "default": 16,
          "minimum": 12,
          "maximum": 24,
          "description": "Content font size in pixels"
        },
        "arkLens.fontFamily": {
          "type": "string",
          "default": "system",
          "enum": ["system", "serif", "mono"],
          "enumDescriptions": [
            "System sans-serif (Segoe UI, SF Pro, Roboto)",
            "Serif (Georgia, Times)",
            "Monospace (Editor font)"
          ],
          "description": "Content font family"
        },
        "arkLens.contentWidth": {
          "type": "string",
          "default": "medium",
          "enum": ["narrow", "medium", "wide"],
          "enumDescriptions": [
            "600px - focused reading",
            "800px - balanced",
            "Full width - use all available space"
          ],
          "description": "Content area maximum width"
        },
        "arkLens.tocVisible": {
          "type": "boolean",
          "default": true,
          "description": "Show table of contents sidebar"
        },
        "arkLens.tocWidth": {
          "type": "number",
          "default": 200,
          "minimum": 100,
          "maximum": 400,
          "description": "Table of contents sidebar width in pixels"
        },
        "arkLens.maxTabs": {
          "type": "number",
          "default": 10,
          "minimum": 1,
          "maximum": 50,
          "description": "Maximum number of open tabs before oldest is closed"
        },
        "arkLens.watchDirectory": {
          "type": "string",
          "default": "",
          "description": "Directory to watch for new/changed Markdown and HTML files (empty = disabled)"
        }
      }
    }
  }
}
```

Listen for configuration changes in extension host:

```typescript
vscode.workspace.onDidChangeConfiguration(e => {
  if (e.affectsConfiguration('arkLens')) {
    // Re-send settings to webview
    const config = vscode.workspace.getConfiguration('arkLens');
    ViewerProvider.instance?.postMessage({
      type: 'initSettings',
      settings: {
        theme: config.get('theme'),
        fontSize: config.get('fontSize'),
        fontFamily: config.get('fontFamily'),
        contentWidth: config.get('contentWidth'),
        tocVisible: config.get('tocVisible'),
        maxTabs: config.get('maxTabs'),
      }
    });
  }
});
```

**Verification:**
- [ ] All settings appear in VS Code Settings UI under "Ark Lens"
- [ ] Changing settings in UI reflects in viewer immediately
- [ ] Changing settings in viewer reflects in Settings UI
- [ ] Settings descriptions are clear and helpful
- [ ] Default values are sensible

## Success Criteria

- [ ] All 5 commands registered and functional
- [ ] Keybindings work on MD and HTML files
- [ ] Context menus appear in Explorer and Editor
- [ ] Settings appear in VS Code Settings with descriptions
- [ ] Bidirectional settings sync (UI â†” viewer)
- [ ] No command conflicts with VS Code built-in commands
