# Plan 03-02: Theme System, Font Controls, Content Width, TOC Sidebar

## Objective

Add the readability controls that make this a daily-driver tool: dark/light theme toggle, font size and family adjustment, content width presets, and a collapsible table-of-contents sidebar that navigates headings. All preferences persist via VS Code postMessage to extension settings.

## Context

@.planning/PROJECT.md
@.planning/phases/03-viewer-experience/03-CONTEXT.md
@.planning/phases/03-viewer-experience/03-01-PLAN.md (completed tab system)

## Pre-Flight

- [ ] Plan 03-01 complete -- tabbed interface working
- [ ] Content renders correctly in both VS Code light and dark themes

## Tasks

### Task 1: Theme System

Create `src/webview/ui/theme.ts`:

```typescript
type Theme = 'light' | 'dark' | 'auto';

class ThemeManager {
  private currentTheme: Theme = 'auto';

  initialize(preference: Theme): void {
    this.currentTheme = preference;
    this.apply();
  }

  toggle(): void {
    if (this.currentTheme === 'auto') {
      // Auto → detect current, flip to opposite
      const isDark = this.detectVsCodeTheme() === 'dark';
      this.currentTheme = isDark ? 'light' : 'dark';
    } else {
      this.currentTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
    }
    this.apply();
    this.persist();
  }

  private apply(): void {
    const effective = this.currentTheme === 'auto'
      ? this.detectVsCodeTheme()
      : this.currentTheme;

    document.body.classList.remove('light', 'dark');
    document.body.classList.add(effective);

    // Notify renderers that need theme update
    window.dispatchEvent(new CustomEvent('theme-changed', { detail: effective }));
  }

  private detectVsCodeTheme(): 'light' | 'dark' {
    // VS Code sets body class 'vscode-light' or 'vscode-dark'
    return document.body.classList.contains('vscode-light') ? 'light' : 'dark';
  }

  private persist(): void {
    vscode.postMessage({ type: 'settingChanged', key: 'theme', value: this.currentTheme });
  }
}
```

Create `src/webview/styles/themes/light.css` and `dark.css`:

Both use CSS custom properties on `body.light` and `body.dark`:

```css
/* light.css */
body.light {
  --ark-bg: #ffffff;
  --ark-fg: #24292e;
  --ark-bg-secondary: #f6f8fa;
  --ark-border: #e1e4e8;
  --ark-link: #0366d6;
  --ark-code-bg: #f6f8fa;
  --ark-blockquote-border: #0366d6;
  --ark-table-header-bg: #f6f8fa;
  --ark-table-border: #dfe2e5;
}

/* dark.css */
body.dark {
  --ark-bg: #0d1117;
  --ark-fg: #c9d1d9;
  --ark-bg-secondary: #161b22;
  --ark-border: #30363d;
  --ark-link: #58a6ff;
  --ark-code-bg: #161b22;
  --ark-blockquote-border: #58a6ff;
  --ark-table-header-bg: #161b22;
  --ark-table-border: #30363d;
}
```

Update `content.css` to use `var(--ark-*)` variables instead of VS Code variables. This gives us independent theme control.

Listen for `theme-changed` event in Mermaid and Chart.js renderers to re-initialise with matching theme.

**Verification:**
- [ ] Toggle switches between light and dark
- [ ] All content elements respect theme variables
- [ ] Mermaid diagrams re-render with correct theme
- [ ] Chart.js charts update colours
- [ ] Code highlighting colours match theme
- [ ] Auto mode follows VS Code theme
- [ ] Theme preference persists across sessions

### Task 2: Font and Width Controls

Create `src/webview/ui/controls.ts`:

```typescript
interface ViewerSettings {
  fontSize: number;      // 12-24, default 16
  fontFamily: string;    // 'system' | 'serif' | 'mono' | 'inter' | 'jetbrains'
  contentWidth: string;  // 'narrow' | 'medium' | 'wide'
}

class ControlsManager {
  private settings: ViewerSettings = {
    fontSize: 16,
    fontFamily: 'system',
    contentWidth: 'medium',
  };

  initialize(settings: Partial<ViewerSettings>): void;

  setFontSize(size: number): void {
    this.settings.fontSize = Math.max(12, Math.min(24, size));
    document.getElementById('content')!.style.fontSize = `${this.settings.fontSize}px`;
    this.persist('fontSize', this.settings.fontSize);
  }

  setFontFamily(family: string): void {
    const fontMap: Record<string, string> = {
      'system': "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
      'serif': "Georgia, 'Times New Roman', serif",
      'mono': "var(--vscode-editor-font-family, 'Consolas', monospace)",
    };
    this.settings.fontFamily = family;
    document.getElementById('content')!.style.fontFamily = fontMap[family] || fontMap.system;
    this.persist('fontFamily', family);
  }

  setContentWidth(width: string): void {
    const widthMap: Record<string, string> = {
      'narrow': '600px',
      'medium': '800px',
      'wide': '100%',
    };
    this.settings.contentWidth = width;
    document.getElementById('content')!.style.maxWidth = widthMap[width] || '800px';
    this.persist('contentWidth', width);
  }

  private persist(key: string, value: unknown): void {
    vscode.postMessage({ type: 'settingChanged', key, value });
  }
}
```

**Control Bar UI** -- collapsible bar at bottom of viewer:

```html
<div id="control-bar">
  <button id="theme-toggle" title="Toggle theme">
    <!-- Sun/Moon SVG icon -->
  </button>
  <div class="control-group">
    <button id="font-decrease" title="Decrease font">A-</button>
    <span id="font-size-display">16px</span>
    <button id="font-increase" title="Increase font">A+</button>
  </div>
  <select id="font-family" title="Font family">
    <option value="system">Sans-serif</option>
    <option value="serif">Serif</option>
    <option value="mono">Monospace</option>
  </select>
  <div class="control-group">
    <button data-width="narrow" title="Narrow">|||</button>
    <button data-width="medium" title="Medium" class="active">| |</button>
    <button data-width="wide" title="Wide">|  |</button>
  </div>
  <button id="toc-toggle" title="Toggle table of contents">
    <!-- List SVG icon -->
  </button>
</div>
```

Create `src/webview/styles/controls.css`:

```css
#control-bar {
  display: flex;
  align-items: center;
  gap: 12px;
  height: 32px;
  padding: 0 12px;
  background: var(--ark-bg-secondary);
  border-top: 1px solid var(--ark-border);
  flex-shrink: 0;
  font-size: 12px;
}

#control-bar button {
  background: none;
  border: 1px solid transparent;
  color: var(--ark-fg);
  cursor: pointer;
  padding: 2px 8px;
  border-radius: 3px;
  font-size: 12px;
}

#control-bar button:hover {
  background: var(--vscode-toolbar-hoverBackground);
}

#control-bar button.active {
  border-color: var(--vscode-focusBorder);
}

#control-bar select {
  background: var(--ark-bg);
  color: var(--ark-fg);
  border: 1px solid var(--ark-border);
  border-radius: 3px;
  padding: 2px 6px;
  font-size: 12px;
}
```

**Verification:**
- [ ] Font size increases/decreases in steps
- [ ] Font family changes visually
- [ ] Content width switches between narrow/medium/wide
- [ ] All settings persist across panel hide/show
- [ ] All settings persist across VS Code restarts (via extension settings)
- [ ] Control bar is visually minimal, not distracting

### Task 3: Table of Contents Sidebar

Create `src/webview/ui/toc.ts`:

```typescript
interface TocEntry {
  id: string;       // Heading element id
  text: string;     // Heading text content
  level: number;    // 1-6
}

class TocManager {
  private entries: TocEntry[] = [];
  private visible: boolean = true;
  private activeId: string | null = null;
  private observer: IntersectionObserver | null = null;

  // Parse headings from rendered content
  generate(): void {
    const headings = document.querySelectorAll('#content h1, #content h2, #content h3, #content h4, #content h5, #content h6');
    this.entries = [];

    headings.forEach((heading, index) => {
      // Ensure heading has an id for navigation
      if (!heading.id) {
        heading.id = `heading-${index}`;
      }
      this.entries.push({
        id: heading.id,
        text: heading.textContent || '',
        level: parseInt(heading.tagName[1]),
      });
    });

    this.render();
    this.observeHeadings();
  }

  // Render TOC sidebar
  private render(): void {
    const sidebar = document.getElementById('toc-sidebar')!;
    if (this.entries.length === 0) {
      sidebar.innerHTML = '<p class="toc-empty">No headings found</p>';
      return;
    }

    const minLevel = Math.min(...this.entries.map(e => e.level));

    sidebar.innerHTML = `
      <div class="toc-title">Contents</div>
      <nav class="toc-nav">
        ${this.entries.map(entry => `
          <a class="toc-entry toc-level-${entry.level - minLevel}"
             href="#${entry.id}"
             data-toc-id="${entry.id}"
             title="${escapeHtml(entry.text)}">
            ${escapeHtml(entry.text)}
          </a>
        `).join('')}
      </nav>
    `;

    // Click handler for smooth scroll
    sidebar.querySelectorAll('.toc-entry').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = (link as HTMLElement).dataset.tocId!;
        document.getElementById(targetId)?.scrollIntoView({ behavior: 'smooth' });
      });
    });
  }

  // Highlight current heading based on scroll position
  private observeHeadings(): void {
    if (this.observer) this.observer.disconnect();

    this.observer = new IntersectionObserver(
      (entries) => {
        for (const entry of entries) {
          if (entry.isIntersecting) {
            this.highlightTocEntry(entry.target.id);
            break;
          }
        }
      },
      { rootMargin: '-10% 0px -80% 0px' }
    );

    this.entries.forEach(({ id }) => {
      const el = document.getElementById(id);
      if (el) this.observer!.observe(el);
    });
  }

  private highlightTocEntry(id: string): void {
    document.querySelectorAll('.toc-entry').forEach(el => {
      el.classList.toggle('active', (el as HTMLElement).dataset.tocId === id);
    });
  }

  toggle(): void {
    this.visible = !this.visible;
    document.getElementById('toc-sidebar')!.classList.toggle('hidden', !this.visible);
    vscode.postMessage({ type: 'settingChanged', key: 'tocVisible', value: this.visible });
  }
}
```

Create `src/webview/styles/toc.css`:

```css
#viewer-body {
  display: flex;
  flex: 1;
  overflow: hidden;
}

#toc-sidebar {
  width: 200px;
  min-width: 150px;
  max-width: 300px;
  overflow-y: auto;
  border-right: 1px solid var(--ark-border);
  background: var(--ark-bg-secondary);
  padding: 12px 0;
  flex-shrink: 0;
  transition: width 0.2s, opacity 0.2s;
}

#toc-sidebar.hidden {
  width: 0;
  min-width: 0;
  padding: 0;
  overflow: hidden;
  opacity: 0;
}

.toc-title {
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--vscode-sideBarSectionHeader-foreground);
  padding: 0 16px 8px;
}

.toc-entry {
  display: block;
  padding: 3px 16px;
  font-size: 13px;
  color: var(--ark-fg);
  text-decoration: none;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  border-left: 2px solid transparent;
}

.toc-entry:hover {
  background: var(--vscode-list-hoverBackground);
}

.toc-entry.active {
  color: var(--ark-link);
  border-left-color: var(--ark-link);
  background: var(--vscode-list-activeSelectionBackground);
}

/* Indent levels */
.toc-level-0 { padding-left: 16px; font-weight: 600; }
.toc-level-1 { padding-left: 28px; }
.toc-level-2 { padding-left: 40px; font-size: 12px; }
.toc-level-3 { padding-left: 52px; font-size: 12px; }
.toc-level-4 { padding-left: 64px; font-size: 11px; }

/* Auto-hide TOC on narrow panels */
@media (max-width: 500px) {
  #toc-sidebar { display: none; }
}
```

**Verification:**
- [ ] TOC generates from headings in content
- [ ] Click on TOC entry scrolls to heading
- [ ] Current heading highlighted as user scrolls
- [ ] TOC collapses/expands on toggle
- [ ] TOC regenerates when switching tabs
- [ ] TOC auto-hides when panel is narrow
- [ ] Empty state when no headings

### Task 4: Settings Persistence Bridge

Update `src/providers/viewerProvider.ts` to handle settings:

```typescript
// Handle messages from webview
panel.webview.onDidReceiveMessage(message => {
  switch (message.type) {
    case 'settingChanged':
      // Persist to VS Code settings
      vscode.workspace.getConfiguration('arkLens')
        .update(message.key, message.value, vscode.ConfigurationTarget.Global);
      break;
    case 'tabChanged':
      panel.title = `Ark Lens: ${message.fileName}`;
      break;
  }
});

// Send saved settings to webview on creation
const config = vscode.workspace.getConfiguration('arkLens');
panel.webview.postMessage({
  type: 'initSettings',
  settings: {
    theme: config.get('theme', 'auto'),
    fontSize: config.get('fontSize', 16),
    fontFamily: config.get('fontFamily', 'system'),
    contentWidth: config.get('contentWidth', 'medium'),
    tocVisible: config.get('tocVisible', true),
    maxTabs: config.get('maxTabs', 10),
  }
});
```

Update webview app to handle `initSettings` message and apply all settings on load.

**Verification:**
- [ ] Changing theme in viewer persists to VS Code settings
- [ ] Restarting VS Code restores all settings
- [ ] Settings apply correctly on panel creation
- [ ] Changing settings in VS Code Settings UI reflects in viewer

### Task 5: Layout Integration

Ensure all pieces fit together:

```
┌─────────────────────────────────────────────────┐
│ [README.md ×] [REPORT.md ×] [plan.html ×]      │  ← Tab bar (36px)
├────────┬────────────────────────────────────────┤
│Contents│                                        │
│        │                                        │
│ # Intro│   Rendered content area                │  ← Flex fill
│  ## API│   (scrollable, themed)                 │
│  ## FAQ│                                        │
│        │                                        │
├────────┴────────────────────────────────────────┤
│ Theme: Dark | Font: 16px Sans | Width: Medium   │  ← Control bar (32px)
└─────────────────────────────────────────────────┘
```

CSS layout:

```css
#app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
  background: var(--ark-bg);
  color: var(--ark-fg);
}

#viewer-body {
  flex: 1;
  display: flex;
  overflow: hidden;
}

#content-area {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
}
```

**Verification:**
- [ ] Layout fills viewport with no scrollbar on outer container
- [ ] Tab bar fixed at top
- [ ] Control bar fixed at bottom
- [ ] Content area fills remaining space and scrolls
- [ ] TOC sidebar sits to the left of content
- [ ] Resizing panel reflows correctly

## Success Criteria

- [ ] Dark/light theme toggle works and syncs with all renderers
- [ ] Font size adjustable 12-24px with visual feedback
- [ ] Font family switches between sans/serif/mono
- [ ] Content width has 3 presets (narrow/medium/wide)
- [ ] TOC sidebar generates, navigates, highlights current heading
- [ ] TOC collapsible and auto-hides on narrow panels
- [ ] All settings persist via VS Code configuration API
- [ ] Layout is clean, professional, no visual bugs
- [ ] Control bar is unobtrusive, accessible
