# Plan 03-01: Tabbed Multi-File Interface

## Objective

Build an internal tab system within the webview panel so multiple files can be open simultaneously, each in its own closable tab. Switching tabs preserves scroll position and rendered state. This is the core UX differentiator -- one panel, many files.

## Context

@.planning/PROJECT.md
@.planning/phases/03-viewer-experience/03-CONTEXT.md
@.planning/phases/02-rich-content/02-02-PLAN.md (completed rich rendering)

## Pre-Flight

- [ ] Phase 2 complete -- all rendering features working
- [ ] Single file viewing works end-to-end

## Tasks

### Task 1: Tab State Model

Create `src/webview/ui/tabs.ts`:

```typescript
interface Tab {
  id: string;              // Unique identifier (hash of filePath)
  filePath: string;        // Full path to file
  fileName: string;        // Display name (basename)
  fileType: 'md' | 'html'; // File type
  content: string;         // Raw source text
  renderedHtml: string;    // Cached rendered output
  scrollTop: number;       // Scroll position
  isActive: boolean;       // Currently visible
  isDirty: boolean;        // Content changed since last render
}

class TabManager {
  private tabs: Tab[] = [];
  private maxTabs: number = 10;
  private activeTabId: string | null = null;

  // Opens file in tab -- if already open, switches to it
  openTab(filePath: string, fileName: string, fileType: 'md' | 'html', content: string): void;

  // Closes tab by id, activates adjacent tab
  closeTab(id: string): void;

  // Switches active tab, preserves scroll of previous
  activateTab(id: string): void;

  // Returns active tab
  getActiveTab(): Tab | null;

  // Returns all tabs for rendering tab bar
  getAllTabs(): Tab[];

  // Updates content for a tab (e.g., file changed)
  updateTabContent(filePath: string, content: string): void;

  // Eviction: when maxTabs exceeded, close oldest inactive tab
  private evictOldest(): void;
}
```

**Key behaviours:**
- Opening already-open file → switch to its tab (no duplicate)
- Closing active tab → activate the tab to its left (or right if leftmost)
- Closing last tab → show welcome/empty state
- Tab eviction → close least-recently-activated tab (not the active one)
- Tab order → insertion order (newest on the right)

**Verification:**
- [ ] Opening 3 files creates 3 tabs
- [ ] Opening same file twice switches to existing tab
- [ ] Closing middle tab activates adjacent tab
- [ ] Closing all tabs shows empty state

### Task 2: Tab Bar UI

Add tab bar HTML structure to webview:

```html
<div id="app">
  <div id="tab-bar">
    <div id="tab-scroll-container">
      <!-- Tabs rendered here -->
    </div>
  </div>
  <div id="viewer-body">
    <div id="toc-sidebar"></div>   <!-- Phase 03-02 -->
    <div id="content-area">
      <div id="content"></div>
    </div>
  </div>
  <div id="control-bar"></div>      <!-- Phase 03-02 -->
</div>
```

Create `src/webview/styles/tabs.css`:

```css
#tab-bar {
  display: flex;
  align-items: center;
  height: 36px;
  background: var(--vscode-editorGroupHeader-tabsBackground);
  border-bottom: 1px solid var(--vscode-panel-border);
  overflow: hidden;
  flex-shrink: 0;
}

#tab-scroll-container {
  display: flex;
  overflow-x: auto;
  scrollbar-width: thin;
  flex: 1;
}

.tab {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 0 12px;
  height: 36px;
  min-width: 80px;
  max-width: 200px;
  cursor: pointer;
  border-right: 1px solid var(--vscode-panel-border);
  background: var(--vscode-tab-inactiveBackground);
  color: var(--vscode-tab-inactiveForeground);
  font-size: 13px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  user-select: none;
}

.tab.active {
  background: var(--vscode-tab-activeBackground);
  color: var(--vscode-tab-activeForeground);
  border-bottom: 2px solid var(--vscode-focusBorder);
}

.tab .close-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  border-radius: 3px;
  opacity: 0;
  transition: opacity 0.1s;
  flex-shrink: 0;
}

.tab:hover .close-btn,
.tab.active .close-btn {
  opacity: 0.7;
}

.tab .close-btn:hover {
  opacity: 1;
  background: var(--vscode-toolbar-hoverBackground);
}

.tab .file-icon {
  width: 14px;
  height: 14px;
  flex-shrink: 0;
}
```

Tab rendering function:

```typescript
function renderTabBar(tabs: Tab[], activeId: string | null): void {
  const container = document.getElementById('tab-scroll-container')!;
  container.innerHTML = tabs.map(tab => `
    <div class="tab ${tab.id === activeId ? 'active' : ''}"
         data-tab-id="${tab.id}"
         title="${tab.filePath}">
      <span class="file-icon">${tab.fileType === 'md' ? '&#9776;' : '&#9671;'}</span>
      <span class="tab-name">${escapeHtml(tab.fileName)}</span>
      <span class="close-btn" data-close-tab="${tab.id}">&times;</span>
    </div>
  `).join('');
}
```

Event handlers:
- Click on tab → `tabManager.activateTab(id)` → swap content
- Click on close button → `tabManager.closeTab(id)` → remove tab
- Middle-click on tab → close tab
- Tab scroll: horizontal mouse wheel on tab bar

**Verification:**
- [ ] Tab bar shows all open files
- [ ] Active tab visually distinct
- [ ] Close button appears on hover
- [ ] Middle-click closes tab
- [ ] Tab overflow scrolls horizontally
- [ ] Tab bar uses VS Code theme colours

### Task 3: Content Switching

When switching tabs:

```typescript
function switchToTab(tab: Tab): void {
  // 1. Save current scroll position of outgoing tab
  const currentTab = tabManager.getActiveTab();
  if (currentTab) {
    currentTab.scrollTop = document.getElementById('content-area')!.scrollTop;
  }

  // 2. Activate new tab in manager
  tabManager.activateTab(tab.id);

  // 3. Swap content
  const contentEl = document.getElementById('content')!;
  if (tab.renderedHtml) {
    // Use cached render
    contentEl.innerHTML = tab.renderedHtml;
  } else {
    // Render fresh
    tab.renderedHtml = renderContent(tab.content, tab.fileType);
    contentEl.innerHTML = tab.renderedHtml;
  }

  // 4. Post-processing (Mermaid, Charts, Highlight)
  await postProcess();

  // 5. Restore scroll position
  document.getElementById('content-area')!.scrollTop = tab.scrollTop;

  // 6. Update tab bar
  renderTabBar(tabManager.getAllTabs(), tab.id);

  // 7. Update panel title
  vscode.postMessage({ type: 'tabChanged', fileName: tab.fileName });
}
```

**Key UX details:**
- Scroll position preserved per tab
- Content is cached after first render (fast switching)
- Panel title updates to show active file name
- Cached content invalidated when file changes (isDirty flag)

Update extension host (`viewerProvider.ts`):
- Handle `tabChanged` message → update panel title
- When opening new file, send content to webview (webview handles tab creation)
- Track which files are open (for auto-refresh targeting)

**Verification:**
- [ ] Switching between tabs is instant (cached render)
- [ ] Scroll position preserved when switching away and back
- [ ] Panel title shows active file name
- [ ] Mermaid diagrams re-render correctly on tab switch
- [ ] Charts re-render correctly on tab switch

### Task 4: Empty State

When no tabs are open, show a welcome screen:

```html
<div id="empty-state">
  <div class="empty-icon"><!-- SVG lens icon --></div>
  <h2>Ark Lens</h2>
  <p>Open a Markdown or HTML file to preview</p>
  <p class="shortcut">Ctrl+Shift+L to open current file</p>
</div>
```

Style: centred, muted colours, VS Code theme aware.

**Verification:**
- [ ] Empty state shows when no tabs open
- [ ] Disappears when first tab opens
- [ ] Returns when last tab closes

### Task 5: Integration with Extension Host

Update message protocol between extension and webview:

**Extension → Webview:**
- `{ type: 'openFile', filePath, fileName, fileType, content }` -- open/switch to file
- `{ type: 'updateFile', filePath, content }` -- refresh content of open file
- `{ type: 'closeFile', filePath }` -- close a specific file's tab

**Webview → Extension:**
- `{ type: 'tabChanged', fileName }` -- active tab changed (update title)
- `{ type: 'requestFile', filePath }` -- webview needs file content (e.g., on reactivation)
- `{ type: 'ready' }` -- webview initialised, ready to receive files

Handle `retainContextWhenHidden`:
- When panel becomes visible again, webview sends `ready`
- Extension re-sends active file content if needed

**Verification:**
- [ ] Opening multiple files from command palette creates tabs
- [ ] Opening same file from different commands doesn't duplicate
- [ ] Panel title reflects active tab
- [ ] Webview survives hide/show cycle

## Success Criteria

- [ ] Multiple files open as tabs within a single panel
- [ ] Tabs are closable (click x, middle-click)
- [ ] Switching tabs is instant (cached content)
- [ ] Scroll position preserved per tab
- [ ] Tab overflow handled (horizontal scroll)
- [ ] Panel title shows active filename
- [ ] Empty state when no tabs
- [ ] Max tabs enforced with graceful eviction
- [ ] No duplicate tabs for same file
