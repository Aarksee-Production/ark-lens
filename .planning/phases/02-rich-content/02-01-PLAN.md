# Plan 02-01: Mermaid Diagrams + Chart.js Charts

## Objective

Add offline Mermaid diagram rendering and Chart.js chart rendering to the viewer. Both libraries are bundled with the extension -- zero network requests. Code blocks with `mermaid` or `chart` language tags render as visual diagrams/charts instead of code.

## Context

@.planning/PROJECT.md
@.planning/phases/02-rich-content/02-CONTEXT.md
@.planning/phases/01-foundation/01-02-PLAN.md (completed rendering pipeline)

## Pre-Flight

- [ ] Phase 1 complete -- markdown rendering + DOMPurify working
- [ ] Webview panel opens and renders .md files correctly

## Tasks

### Task 1: Install Dependencies

```bash
cd ark-lens
npm install mermaid chart.js
```

Both bundle into the webview (browser context).

**Verification:**
- [ ] Packages installed, no deprecation warnings
- [ ] Check sizes: `node_modules/mermaid` and `node_modules/chart.js`

### Task 2: markdown-it Code Block Hook

Update `src/webview/renderer/markdown.ts`:

Add a custom fence renderer that intercepts special language tags BEFORE DOMPurify:

```typescript
// Store original fence renderer
const defaultFence = md.renderer.rules.fence;

md.renderer.rules.fence = (tokens, idx, options, env, self) => {
  const token = tokens[idx];
  const lang = token.info.trim().toLowerCase();
  const content = token.content;

  if (lang === 'mermaid') {
    // Return a placeholder div -- Mermaid renders post-DOM-insertion
    const id = `mermaid-${idx}-${Date.now()}`;
    return `<div class="ark-mermaid" data-mermaid-id="${id}">${escapeHtml(content)}</div>`;
  }

  if (lang === 'chart' || lang === 'chartjs') {
    const id = `chart-${idx}-${Date.now()}`;
    return `<div class="ark-chart" data-chart-id="${id}"><pre class="ark-chart-config">${escapeHtml(content)}</pre></div>`;
  }

  // Default rendering for all other code blocks
  if (defaultFence) {
    return defaultFence(tokens, idx, options, env, self);
  }
  return `<pre><code class="language-${lang}">${escapeHtml(content)}</code></pre>`;
};
```

**Key design:**
- Special blocks become `<div>` placeholders with escaped content
- Content is stored as text (never executed)
- After DOMPurify runs, a post-processing step finds these divs and renders them
- DOMPurify config updated to allow `data-mermaid-id` and `data-chart-id` on divs with class `ark-mermaid` and `ark-chart`

Update DOMPurify config:
- Add `data-mermaid-id` and `data-chart-id` to ALLOWED_ATTR
- Add `canvas` to ALLOWED_TAGS (for Chart.js)

**Verification:**
- [ ] `mermaid` code blocks produce placeholder divs
- [ ] `chart` code blocks produce placeholder divs
- [ ] Regular code blocks render unchanged
- [ ] Placeholder content is HTML-escaped (no injection)

### Task 3: Mermaid Renderer Module

Create `src/webview/renderer/mermaid.ts`:

```typescript
import mermaid from 'mermaid';

let initialized = false;

export function initMermaid(isDark: boolean): void {
  mermaid.initialize({
    startOnLoad: false,       // We control rendering manually
    theme: isDark ? 'dark' : 'default',
    securityLevel: 'strict',  // No click handlers, no scripts
    fontFamily: 'inherit',
    logLevel: 'error',        // Suppress info logs
  });
  initialized = true;
}

export async function renderMermaidBlocks(): Promise<void> {
  if (!initialized) initMermaid(document.body.classList.contains('dark'));

  const blocks = document.querySelectorAll('.ark-mermaid');
  for (const block of blocks) {
    const id = block.getAttribute('data-mermaid-id') || `mermaid-${Date.now()}`;
    const definition = block.textContent || '';

    try {
      const { svg } = await mermaid.render(id, definition);
      block.innerHTML = svg;
      block.classList.add('ark-mermaid-rendered');
    } catch (err) {
      // Show error message in the block, not silently fail
      block.innerHTML = `<div class="ark-render-error">Mermaid error: ${escapeHtml(String(err))}</div>`;
      block.classList.add('ark-mermaid-error');
    }
  }
}
```

**Key design:**
- `securityLevel: 'strict'` -- no click event bindings in diagrams
- Manual rendering (not startOnLoad) for control
- Errors shown inline, not swallowed
- Theme syncs with viewer dark/light mode
- SVG output injected directly (Mermaid renders to SVG, which is safe)

**Verification:**
- [ ] Flowchart: `graph TD; A-->B-->C;` renders as a diagram
- [ ] Sequence diagram: `sequenceDiagram; Alice->>Bob: Hello` renders
- [ ] Invalid Mermaid syntax shows error message, not crash
- [ ] Diagram inherits viewer theme (dark/light)

### Task 4: Chart.js Renderer Module

Create `src/webview/renderer/charts.ts`:

```typescript
import { Chart, registerables } from 'chart.js';

Chart.register(...registerables);

// Track instances for cleanup
const chartInstances = new Map<string, Chart>();

export function renderChartBlocks(): void {
  const blocks = document.querySelectorAll('.ark-chart');

  for (const block of blocks) {
    const id = block.getAttribute('data-chart-id') || `chart-${Date.now()}`;
    const configEl = block.querySelector('.ark-chart-config');
    if (!configEl) continue;

    const rawConfig = configEl.textContent || '';

    try {
      const config = JSON.parse(rawConfig);

      // Validate: must have 'type' and 'data' at minimum
      if (!config.type || !config.data) {
        throw new Error('Chart config must have "type" and "data" properties');
      }

      // Destroy existing chart if re-rendering
      if (chartInstances.has(id)) {
        chartInstances.get(id)!.destroy();
      }

      // Replace content with canvas
      block.innerHTML = `<canvas id="${id}" style="max-height: 400px;"></canvas>`;
      const canvas = document.getElementById(id) as HTMLCanvasElement;

      // Apply theme-aware defaults
      const isDark = document.body.classList.contains('dark');
      config.options = config.options || {};
      config.options.responsive = true;
      config.options.maintainAspectRatio = true;
      if (isDark) {
        config.options.color = '#ccc';
        config.options.borderColor = '#555';
      }

      const chart = new Chart(canvas, config);
      chartInstances.set(id, chart);
      block.classList.add('ark-chart-rendered');
    } catch (err) {
      block.innerHTML = `<div class="ark-render-error">Chart error: ${escapeHtml(String(err))}</div>`;
      block.classList.add('ark-chart-error');
    }
  }
}

export function destroyAllCharts(): void {
  chartInstances.forEach(chart => chart.destroy());
  chartInstances.clear();
}
```

**Key design:**
- Chart config is pure JSON (no function execution -- Chart.js processes data, not code)
- Charts are responsive with max height
- Instance tracking prevents memory leaks on re-render
- Theme-aware defaults for dark mode
- Invalid JSON or missing config shows inline error

**Example chart code block in markdown:**
````markdown
```chart
{
  "type": "bar",
  "data": {
    "labels": ["Jan", "Feb", "Mar"],
    "datasets": [{
      "label": "Revenue",
      "data": [10, 20, 30]
    }]
  }
}
```
````

**Verification:**
- [ ] Bar chart renders from JSON config
- [ ] Line chart renders
- [ ] Pie/doughnut chart renders
- [ ] Invalid JSON shows error message
- [ ] Missing `type` or `data` shows helpful error
- [ ] Charts adapt to dark/light theme
- [ ] Re-rendering same chart destroys previous instance (no memory leak)

### Task 5: Wire Into Webview App

Update `src/webview/app.ts`:
- Import `initMermaid`, `renderMermaidBlocks` from `./renderer/mermaid`
- Import `renderChartBlocks`, `destroyAllCharts` from `./renderer/charts`
- After setting innerHTML from markdown render:
  1. `await renderMermaidBlocks()`
  2. `renderChartBlocks()`
- On theme change: re-initialize Mermaid with new theme, re-render
- On content update: destroy old charts, re-render all

Add to `src/webview/styles/base.css`:
```css
.ark-mermaid, .ark-chart { margin: 16px 0; text-align: center; }
.ark-mermaid svg { max-width: 100%; }
.ark-chart canvas { max-width: 100%; }
.ark-render-error {
  background: var(--vscode-inputValidation-errorBackground);
  color: var(--vscode-inputValidation-errorForeground);
  border: 1px solid var(--vscode-inputValidation-errorBorder);
  padding: 12px;
  border-radius: 4px;
  font-family: monospace;
  font-size: 0.9em;
}
```

### Task 6: Build and Test

- Run `npm run build` -- check bundle size increase
- Expected: webview.js grows by ~2.4MB (Mermaid ~2MB, Chart.js ~200KB, Prism ~150KB later)
- Total should be under 3MB
- Test with a .md file containing:
  - A Mermaid flowchart
  - A Mermaid sequence diagram
  - A Chart.js bar chart
  - A Chart.js line chart
  - Regular code blocks (should render as code, not diagrams)
  - Invalid Mermaid syntax (should show error)
  - Invalid chart JSON (should show error)

**Verification:**
- [ ] All Mermaid diagrams render visually
- [ ] All Chart.js charts render visually
- [ ] Regular code blocks unaffected
- [ ] Errors display inline, not crash the viewer
- [ ] Bundle size under 4MB total
- [ ] Zero CSP violations
- [ ] Zero network requests

## Success Criteria

- [ ] `mermaid` code blocks render as SVG diagrams
- [ ] `chart`/`chartjs` code blocks render as canvas charts
- [ ] Both respect dark/light theme
- [ ] Error handling is graceful (inline messages)
- [ ] No code from content is ever executed
- [ ] Zero CSP violations, zero network requests
- [ ] Bundle size increase is acceptable (<3MB)
