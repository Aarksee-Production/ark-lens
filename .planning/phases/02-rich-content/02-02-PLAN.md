# Plan 02-02: Syntax Highlighting, HTML Viewing, Media Embeds

## Objective

Complete the rich content pipeline: syntax-highlighted code blocks via Prism.js, standalone HTML file viewing with sanitisation, and local media embed support (images with resolved paths, video, audio).

## Context

@.planning/PROJECT.md
@.planning/phases/02-rich-content/02-CONTEXT.md
@.planning/phases/02-rich-content/02-01-PLAN.md (completed Mermaid + Charts)

## Pre-Flight

- [ ] Plan 02-01 complete -- Mermaid and Chart.js working
- [ ] markdown-it custom fence renderer in place

## Tasks

### Task 1: Prism.js Syntax Highlighting

```bash
cd ark-lens
npm install prismjs
npm install -D @types/prismjs
```

Create `src/webview/renderer/highlight.ts`:

```typescript
import Prism from 'prismjs';

// Import commonly used languages
// Core: markup, css, clike, javascript included by default
import 'prismjs/components/prism-typescript';
import 'prismjs/components/prism-python';
import 'prismjs/components/prism-bash';
import 'prismjs/components/prism-json';
import 'prismjs/components/prism-yaml';
import 'prismjs/components/prism-markdown';
import 'prismjs/components/prism-go';
import 'prismjs/components/prism-rust';
import 'prismjs/components/prism-sql';
import 'prismjs/components/prism-toml';
import 'prismjs/components/prism-docker';
import 'prismjs/components/prism-diff';
import 'prismjs/components/prism-powershell';
import 'prismjs/components/prism-jsx';
import 'prismjs/components/prism-tsx';
import 'prismjs/components/prism-scss';
import 'prismjs/components/prism-graphql';
import 'prismjs/components/prism-regex';

export function highlightCodeBlocks(): void {
  const blocks = document.querySelectorAll('pre > code[class*="language-"]');
  blocks.forEach(block => {
    // Skip already highlighted blocks
    if (block.classList.contains('ark-highlighted')) return;
    // Skip mermaid and chart blocks (handled separately)
    if (block.parentElement?.classList.contains('ark-mermaid')) return;
    if (block.parentElement?.classList.contains('ark-chart')) return;

    Prism.highlightElement(block);
    block.classList.add('ark-highlighted');
  });
}
```

Create `src/webview/styles/highlight.css`:
- Import Prism's VS Code-like theme or create custom one
- Override Prism colours with CSS custom properties for theme support:
```css
/* Light theme tokens */
:root {
  --code-keyword: #0000ff;
  --code-string: #a31515;
  --code-comment: #008000;
  --code-function: #795e26;
  --code-number: #098658;
  --code-operator: #000000;
  --code-punctuation: #393a34;
}
/* Dark theme tokens */
.dark {
  --code-keyword: #569cd6;
  --code-string: #ce9178;
  --code-comment: #6a9955;
  --code-function: #dcdcaa;
  --code-number: #b5cea8;
  --code-operator: #d4d4d4;
  --code-punctuation: #d4d4d4;
}
.token.keyword { color: var(--code-keyword); }
.token.string { color: var(--code-string); }
/* ... etc for all token types */
```

**Verification:**
- [ ] TypeScript, Python, Bash, JSON code blocks highlighted
- [ ] Colours match dark/light theme
- [ ] Unknown languages render as plain code (no error)
- [ ] Mermaid and chart blocks NOT affected by highlighter

### Task 2: Standalone HTML File Viewing

Create `src/webview/renderer/html.ts`:

```typescript
import DOMPurify from 'dompurify';

const htmlPurifyConfig = {
  // More permissive than markdown HTML -- allow layout elements
  ALLOWED_TAGS: [
    // Everything from markdown config PLUS:
    'header', 'footer', 'nav', 'main', 'aside',
    'abbr', 'address', 'cite', 'time', 'data',
    'ruby', 'rt', 'rp', 'bdi', 'bdo', 'wbr',
    'map', 'area',
  ],
  ALLOWED_ATTR: [
    // Standard safe attributes
    'href', 'src', 'alt', 'title', 'class', 'id',
    'width', 'height', 'lang', 'dir', 'tabindex',
    'colspan', 'rowspan', 'headers', 'scope',
    'controls', 'autoplay', 'loop', 'muted', 'poster',
    'datetime', 'cite', 'data-*',
    'role', 'aria-*', // Accessibility
  ],
  FORBID_TAGS: ['script', 'iframe', 'object', 'embed', 'form', 'button', 'select', 'textarea', 'link', 'meta'],
  FORBID_ATTR: ['onerror', 'onload', 'onclick', 'onmouseover', 'onfocus', 'onblur', 'onsubmit', 'onchange', 'style'],
  ALLOW_DATA_ATTR: true, // HTML files may use data attributes legitimately
};

export function sanitizeHtml(rawHtml: string): string {
  return DOMPurify.sanitize(rawHtml, htmlPurifyConfig);
}
```

Update `src/webview/app.ts`:
- On message with `fileType: 'html'`:
  - Parse raw HTML
  - Extract `<body>` content (if full HTML document with `<html><head><body>`)
  - Sanitise with `sanitizeHtml()`
  - Inject into content area
  - Apply highlight to any `<code>` blocks within
- On message with `fileType: 'md'`:
  - Use existing markdown pipeline

Update `src/providers/viewerProvider.ts`:
- Detect file type from extension: `.md` → `'md'`, `.html`/`.htm` → `'html'`
- Send appropriate `fileType` in message

**Verification:**
- [ ] Opening a .html file renders its content
- [ ] Full HTML document (with `<html>`, `<head>`, `<body>`) extracts body content
- [ ] Fragment HTML renders directly
- [ ] Scripts in HTML files are stripped
- [ ] Inline styles are stripped (style attribute)
- [ ] `<style>` blocks are stripped
- [ ] Layout renders reasonably (structure preserved, scripts removed)

### Task 3: Local Media Path Resolution

Update `src/providers/viewerProvider.ts`:
- When sending content to webview, also send the file's directory URI
- Method to resolve relative image/media paths to webview-accessible URIs:

```typescript
private resolveLocalPaths(html: string, fileDir: vscode.Uri): string {
  // Expand localResourceRoots to include the file's directory
  // Convert relative src/href to vscode-resource URIs

  // Pattern: src="./image.png" or src="image.png" or src="../assets/photo.jpg"
  return html.replace(
    /(src|href)="(?!https?:\/\/|data:|vscode-resource:)([^"]+)"/g,
    (match, attr, relativePath) => {
      const absoluteUri = vscode.Uri.joinPath(fileDir, relativePath);
      const webviewUri = this.panel.webview.asWebviewUri(absoluteUri);
      return `${attr}="${webviewUri}"`;
    }
  );
}
```

Update `createOrShow()`:
- Dynamically set `localResourceRoots` to include:
  1. Extension's `dist/` directory
  2. Extension's `media/` directory
  3. The opened file's parent directory (for relative media paths)
  4. Workspace root (for absolute workspace-relative paths)

**Important:** `localResourceRoots` is set at panel creation. When opening files from different directories, the panel may need to be recreated or the roots updated. Strategy:
- Set workspace root as a localResourceRoot (covers all project files)
- If no workspace, set the file's directory

**Verification:**
- [ ] Image with relative path `![photo](./images/photo.png)` renders
- [ ] Image with parent path `![photo](../assets/photo.png)` renders
- [ ] `<img src="images/photo.png">` in HTML files renders
- [ ] Video `<video src="./demo.mp4" controls>` plays
- [ ] Audio `<audio src="./recording.mp3" controls>` plays
- [ ] Remote URLs in images are NOT loaded (CSP blocks)
- [ ] `data:` URIs for small inline images work

### Task 4: Render Order Integration

Update `src/webview/app.ts` with correct rendering order:

```typescript
async function renderContent(text: string, fileType: string): Promise<void> {
  const contentEl = document.getElementById('content')!;

  if (fileType === 'html') {
    contentEl.innerHTML = sanitizeHtml(text);
  } else {
    contentEl.innerHTML = renderMarkdown(text);
  }

  // Post-processing order matters:
  // 1. Syntax highlighting (fast, DOM-only)
  highlightCodeBlocks();

  // 2. Mermaid (async, renders SVG)
  await renderMermaidBlocks();

  // 3. Charts (sync, renders canvas)
  renderChartBlocks();
}
```

Wire up content refresh on file change notification.

### Task 5: Test with Complex Content

Create a test file `test-content.md` with:
- Regular headings, paragraphs, lists
- Code blocks in TypeScript, Python, Bash, JSON
- Mermaid flowchart and sequence diagram
- Chart.js bar chart and line chart
- Local image reference
- Inline HTML with a div
- A deliberately malicious script tag
- A deliberately malicious `<img onerror="alert(1)">` tag

Run full test suite:

**Verification:**
- [ ] All code blocks syntax highlighted with correct colours
- [ ] Mermaid diagrams render as visual SVGs
- [ ] Charts render as canvas elements
- [ ] Local images display
- [ ] Script tags stripped
- [ ] Event handler attributes stripped
- [ ] Everything renders in under 1 second for a typical file
- [ ] Zero CSP violations
- [ ] Zero network requests

## Success Criteria

- [ ] 20 common languages syntax highlighted correctly
- [ ] Standalone .html files render with sanitised output
- [ ] Local images, video, audio display via webview URI resolution
- [ ] Remote media blocked by CSP
- [ ] All rich content (Mermaid, Charts, code, media) coexists in single file
- [ ] Rendering order is stable (no race conditions)
- [ ] Bundle size still under 5MB total
