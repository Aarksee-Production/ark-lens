# Plan 01-02: Markdown Rendering Pipeline + Basic Styling

## Objective

Wire up markdown-it with GFM extensions and DOMPurify sanitisation so that opening a .md file renders beautiful, safe HTML in the webview panel. Add a clean default stylesheet for rendered content.

## Context

@.planning/PROJECT.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-01-PLAN.md (completed scaffold)

## Pre-Flight

- [ ] Extension scaffold from 01-01 is working
- [ ] Webview panel opens and shows raw content

## Tasks

### Task 1: Install Rendering Dependencies

```bash
cd ark-lens
npm install markdown-it dompurify
npm install -D @types/markdown-it @types/dompurify
```

These bundle into the webview (browser context), not the extension host.

**Verification:**
- [ ] Packages installed without errors
- [ ] No deprecated package warnings

### Task 2: Markdown Renderer Module

Create `src/webview/renderer/markdown.ts`:

```typescript
// Initialize markdown-it with GFM-like features
import MarkdownIt from 'markdown-it';
import DOMPurify from 'dompurify';

const md = new MarkdownIt({
  html: true,          // Allow HTML in source (DOMPurify will sanitise)
  linkify: true,       // Auto-link URLs
  typographer: true,   // Smart quotes, dashes
  breaks: true,        // Convert \n to <br> in paragraphs
});

// DOMPurify config -- allow safe HTML, strip dangerous elements
const purifyConfig = {
  ALLOWED_TAGS: [
    // Structure
    'h1','h2','h3','h4','h5','h6','p','br','hr','div','span','section','article',
    // Text
    'strong','em','b','i','u','s','del','ins','mark','sub','sup','small',
    // Lists
    'ul','ol','li','dl','dt','dd',
    // Tables
    'table','thead','tbody','tfoot','tr','th','td','caption','colgroup','col',
    // Code
    'pre','code','kbd','samp','var',
    // Media (local only)
    'img','video','audio','source','picture','figure','figcaption',
    // Links
    'a',
    // Block
    'blockquote','details','summary',
    // Forms (display only, non-interactive)
    'input', // for task list checkboxes
  ],
  ALLOWED_ATTR: [
    'href','src','alt','title','class','id','width','height',
    'colspan','rowspan','align','valign',
    'type','checked','disabled', // for task list checkboxes
    'controls','autoplay','loop','muted','poster', // media
    'open', // details
    'start','reversed', // ol
    'data-line', // line mapping
  ],
  FORBID_TAGS: ['script','style','iframe','object','embed','form','button','select','textarea'],
  FORBID_ATTR: ['onerror','onload','onclick','onmouseover','onfocus','onblur','style'],
  ALLOW_DATA_ATTR: false,
};

export function renderMarkdown(source: string): string {
  const rawHtml = md.render(source);
  return DOMPurify.sanitize(rawHtml, purifyConfig);
}
```

**Key design decisions:**
- `html: true` in markdown-it so inline HTML renders, but DOMPurify catches anything dangerous
- Task list checkboxes: `input[type=checkbox]` allowed but forced `disabled`
- No `style` attribute allowed -- all styling via CSS classes
- No `data-*` attributes -- reduces attack surface
- Media tags allowed for local images/video/audio (Phase 2 will handle URI resolution)

**Verification:**
- [ ] `renderMarkdown('# Hello')` returns `<h1>Hello</h1>`
- [ ] `renderMarkdown('<script>alert(1)</script>')` returns empty string
- [ ] `renderMarkdown('**bold** and *italic*')` renders correctly
- [ ] Tables, task lists, and blockquotes render correctly
- [ ] Inline HTML like `<div class="note">text</div>` preserved (without style attr)

### Task 3: Wire Renderer into Webview App

Update `src/webview/app.ts`:
- Import `renderMarkdown` from `./renderer/markdown`
- On `content` message with markdown source:
  - Call `renderMarkdown(text)`
  - Set `document.getElementById('content').innerHTML = sanitisedHtml`
- On `content` message with HTML file:
  - Sanitise with DOMPurify directly (no markdown-it)
  - Inject into content div

Update `src/providers/viewerProvider.ts`:
- Read the active document's text content
- Post message to webview: `{ type: 'content', text: documentText, filePath, fileName, fileType: 'md' | 'html' }`
- `localResourceRoots` should now also include the file's parent directory (for local images)

**Verification:**
- [ ] Opening a .md file shows rendered HTML (headings, bold, lists, etc.)
- [ ] Opening a .html file shows rendered HTML (sanitised)
- [ ] Script tags in .md files are stripped
- [ ] Malicious HTML attributes (onclick, onerror) are stripped
- [ ] Images with local relative paths show correctly

### Task 4: Content Stylesheet

Create `src/webview/styles/content.css`:

Styles for rendered markdown content. Use VS Code theme variables where possible:

```css
/* Typography */
#content {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-size: 16px;
  line-height: 1.7;
  color: var(--vscode-editor-foreground);
  max-width: 800px;
  margin: 0 auto;
  padding: 24px 32px;
}

/* Headings - clear hierarchy */
h1 { font-size: 2em; border-bottom: 1px solid var(--vscode-panel-border); padding-bottom: 0.3em; }
h2 { font-size: 1.5em; border-bottom: 1px solid var(--vscode-panel-border); padding-bottom: 0.3em; }
h3 { font-size: 1.25em; }

/* Code blocks - distinct background */
pre { background: var(--vscode-textBlockQuote-background); padding: 16px; border-radius: 6px; overflow-x: auto; }
code { font-family: var(--vscode-editor-font-family, 'Consolas', monospace); font-size: 0.9em; }
:not(pre) > code { background: var(--vscode-textBlockQuote-background); padding: 2px 6px; border-radius: 3px; }

/* Tables - clean borders */
table { border-collapse: collapse; width: 100%; margin: 16px 0; }
th, td { border: 1px solid var(--vscode-panel-border); padding: 8px 12px; text-align: left; }
th { background: var(--vscode-textBlockQuote-background); font-weight: 600; }

/* Blockquotes */
blockquote { border-left: 4px solid var(--vscode-textLink-foreground); margin: 16px 0; padding: 8px 16px; color: var(--vscode-descriptionForeground); }

/* Task lists */
input[type="checkbox"] { margin-right: 8px; }

/* Links */
a { color: var(--vscode-textLink-foreground); }
a:hover { color: var(--vscode-textLink-activeForeground); }

/* Images */
img { max-width: 100%; height: auto; border-radius: 4px; }

/* Horizontal rule */
hr { border: none; border-top: 1px solid var(--vscode-panel-border); margin: 24px 0; }
```

Import into webview bundle.

**Verification:**
- [ ] Headings have clear visual hierarchy
- [ ] Code blocks have distinct background
- [ ] Tables have clean borders and header styling
- [ ] Content respects VS Code's light/dark theme
- [ ] Images scale to fit content width
- [ ] Content is centred with comfortable reading width

### Task 5: Build and Integration Test

- Run `npm run build` -- verify clean build with markdown-it and DOMPurify bundled
- Check bundle size: webview.js should be under 500KB at this stage
- Launch Extension Development Host:
  - Open a complex .md file (with headings, code, tables, lists, blockquotes, images)
  - Verify all elements render correctly
  - Open VS Code Developer Tools → Console → verify zero CSP violations
  - Check Network tab → verify zero network requests
  - Test with malicious markdown (script injections, event handlers) → verify stripped

**Verification:**
- [ ] Bundle builds cleanly
- [ ] webview.js < 500KB
- [ ] Complex markdown renders correctly
- [ ] Malicious content is sanitised
- [ ] Zero CSP violations
- [ ] Zero network requests
- [ ] Extension works in both light and dark VS Code themes

## Success Criteria

- [ ] Any well-formed Markdown file renders with correct formatting in the panel
- [ ] All GFM features work: tables, task lists, strikethrough, autolinks
- [ ] HTML in Markdown is rendered but sanitised (no scripts, no event handlers)
- [ ] Standalone .html files render (sanitised)
- [ ] VS Code theme colours respected (light and dark)
- [ ] Zero CSP violations, zero network requests
- [ ] Build is clean, bundle size reasonable
