# Plan 01-01: Extension Scaffold, Webview Panel, Strict CSP

## Objective

Create the Ark Lens VS Code extension from scratch with a functioning webview panel that opens to the right of the active editor, enforces strict CSP, and displays a placeholder page. This is the skeleton.

## Context

@.planning/PROJECT.md
@.planning/phases/01-foundation/01-CONTEXT.md

## Pre-Flight

- [ ] Confirm Node.js and npm are available
- [ ] Confirm no existing `ark-lens/` directory in workspace

## Tasks

### Task 1: Project Scaffold

Create `ark-lens/` directory in workspace root with:

```
ark-lens/
  package.json
  tsconfig.json
  esbuild.config.mjs
  .vscodeignore
  .gitignore
  src/
    extension.ts
    providers/
      viewerProvider.ts
  src/webview/
    index.html
    app.ts
    styles/
      base.css
  media/
    icon.svg
```

**package.json requirements:**
- `name`: `ark-lens`
- `displayName`: `Ark Lens`
- `description`: `Secure offline Markdown and HTML viewer`
- `version`: `0.1.0`
- `engines.vscode`: `^1.85.0` (webview improvements)
- `activationEvents`: `onLanguage:markdown`, `onLanguage:html`
- `main`: `./dist/extension.js`
- `contributes.commands`: `arkLens.openPreview` with title "Ark Lens: Open Preview"
- `contributes.keybindings`: `Ctrl+Shift+L` for openPreview when editorLangId matches markdown or html
- No `contributes.configuration` yet (Phase 4)

**tsconfig.json:**
- `target`: `ES2022`
- `module`: `Node16`
- `strict`: true
- `outDir`: `./dist`
- Include `src/**/*`

**esbuild.config.mjs:**
- Two build entries:
  1. Extension host: `src/extension.ts` → `dist/extension.js` (Node, external `vscode`)
  2. Webview: `src/webview/app.ts` → `dist/webview.js` (browser, bundle all deps)
- CSS bundled separately for webview
- Production mode: minify, sourcemap

**.vscodeignore:**
- Exclude: `src/`, `node_modules/`, `*.ts`, `tsconfig.json`, `esbuild.config.mjs`, `.gitignore`
- Include: `dist/`, `media/`, `package.json`, `README.md`, `LICENSE`

**Verification:**
- [ ] `npm install` completes without errors
- [ ] `npm run build` produces `dist/extension.js` and `dist/webview.js`

### Task 2: Extension Entry Point

`src/extension.ts`:
- Export `activate(context)` and `deactivate()`
- Register command `arkLens.openPreview`:
  - Get active text editor
  - If file is `.md` or `.html`, create/reveal ViewerProvider panel
  - If no active editor or wrong file type, show info message
- Push command disposable to `context.subscriptions`

**Verification:**
- [ ] Extension activates without errors in Extension Development Host
- [ ] Command appears in command palette

### Task 3: Webview Panel Provider

`src/providers/viewerProvider.ts`:
- Class `ViewerProvider` managing a single `WebviewPanel`
- `createOrShow(extensionUri, document)` method:
  - If panel exists, reveal it and update content
  - If not, create panel in `ViewColumn.Beside` with options:
    - `enableScripts: true` (needed for Mermaid/Chart.js later)
    - `localResourceRoots: [extensionUri/dist, extensionUri/media]`
    - `retainContextWhenHidden: true` (preserve tab state when panel hidden)
- `getHtmlForWebview(webview)` method:
  - Generate nonce for CSP
  - Build CSP header: `default-src 'none'; style-src ${cspSource} 'unsafe-inline'; script-src 'nonce-${nonce}'; img-src ${cspSource} vscode-resource: data:; font-src ${cspSource};`
  - Return HTML with:
    - CSP meta tag
    - Link to bundled CSS (`webview.css`)
    - Script tag with nonce loading `webview.js`
    - `<div id="app"></div>` mount point
- Handle `onDidDispose` to clean up panel reference
- Message passing: `postMessage({ type: 'content', text, filePath, fileName })` to send file content to webview

**Verification:**
- [ ] Panel opens to the right of editor
- [ ] CSP meta tag present in webview HTML (inspect via Developer Tools)
- [ ] No CSP violations in console
- [ ] Panel survives hide/show (retainContextWhenHidden)

### Task 4: Basic Webview App

`src/webview/app.ts`:
- Listen for messages from extension host via `window.addEventListener('message')`
- On `content` message: set `document.getElementById('content').innerHTML` to received text
- For now, display raw text (no markdown parsing yet -- that's Plan 01-02)
- Acquire VS Code API: `const vscode = acquireVsCodeApi()`

`src/webview/index.html`:
- Minimal template (used as reference, actual HTML generated by provider)

`src/webview/styles/base.css`:
- Reset styles
- `#app` fills viewport
- `#content` area with padding, max-width, line-height for readability
- Use `var(--vscode-editor-foreground)` and `var(--vscode-editor-background)` for base colours (inherits VS Code theme)
- Scrollable content area

`media/icon.svg`:
- Simple SVG lens/eye icon for the extension

**Verification:**
- [ ] Opening a .md file and running command shows raw file content in right panel
- [ ] Panel uses VS Code's current theme colours
- [ ] Content is scrollable
- [ ] No network requests (check DevTools Network tab)

### Task 5: NPM Scripts

Add to `package.json` scripts:
- `build`: Run esbuild for both extension and webview (production)
- `watch`: Run esbuild in watch mode for development
- `package`: `vsce package` (for later use)
- `lint`: `tsc --noEmit` (type checking)

**Verification:**
- [ ] `npm run build` succeeds
- [ ] `npm run watch` starts and rebuilds on file change
- [ ] `npm run lint` reports no type errors

## Success Criteria

- [ ] Extension installs and activates in VS Code Extension Development Host
- [ ] `Ctrl+Shift+L` on a .md file opens webview panel to the right
- [ ] Panel shows raw file content (markdown rendering is next plan)
- [ ] Strict CSP enforced -- no CSP violations in console
- [ ] Zero network requests from extension or webview
- [ ] `localResourceRoots` restricted to extension directories only
- [ ] Build produces clean output with no warnings
- [ ] Extension does not activate unnecessarily (lazy activation)

## Anti-Patterns

- Do NOT use deprecated `vscode.previewHtml` command
- Do NOT use `innerHTML` with unsanitised content (placeholder for now, DOMPurify in 01-02)
- Do NOT add any CDN links or external resources
- Do NOT add markdown rendering yet (that's Plan 01-02)
